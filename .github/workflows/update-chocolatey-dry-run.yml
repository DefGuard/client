name: Chocolatey update dry run

on:
  push:
    tags-ignore:
      - v*.*.*

jobs:
  chocolatey-dry-run:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Resolve latest release tag
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = gh release list --limit 20 --exclude-drafts --json tagName,isPrerelease --jq '.[] | select(.isPrerelease==false) | .tagName' | Select-Object -First 1
          if (-not $tag) { throw "No non-prerelease tags found." }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append
          $version = $tag.TrimStart('v').Split('-')[0]
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download MSI asset
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $msiName = "Defguard_${env:VERSION}_x64_en-US.msi"
          gh release download "$env:RELEASE_TAG" --pattern $msiName --dir "$pwd"

      - name: Calculate MSI checksum
        shell: pwsh
        run: |
          $msiName = "Defguard_${env:VERSION}_x64_en-US.msi"
          $hash = (Get-FileHash -Algorithm SHA256 -Path $msiName).Hash.ToLower()
          "MSI_SHA256=$hash" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Update Chocolatey package files
        shell: pwsh
        working-directory: chocolatey/defguard
        run: |
          $msiUrl = "https://github.com/DefGuard/client/releases/download/v${env:VERSION}/Defguard_${env:VERSION}_x64_en-US.msi"
          $nuspecPath = "defguard.nuspec"
          $installPath = "tools\chocolateyinstall.ps1"

          (Get-Content -Raw $nuspecPath) `
            -replace '<version>[^<]+</version>', "<version>$env:VERSION</version>" `
            -replace '<packageSourceUrl>[^<]+</packageSourceUrl>', "<packageSourceUrl>$msiUrl</packageSourceUrl>" |
            Set-Content -NoNewline -Encoding UTF8 $nuspecPath

          (Get-Content -Raw $installPath) `
            -replace "^\$url\s*=\s*'.*'$", "`$url        = '$msiUrl'" `
            -replace "checksum\s*=\s*'[^']+'", "checksum      = '$env:MSI_SHA256'" |
            Set-Content -NoNewline -Encoding UTF8 $installPath

      - name: Debug updated files
        shell: pwsh
        working-directory: chocolatey/defguard
        run: |
          Write-Output "=== defguard.nuspec ==="
          Get-Content defguard.nuspec
          Write-Output "=== tools\chocolateyinstall.ps1 ==="
          Get-Content tools\chocolateyinstall.ps1

      - name: Refresh local nupkg
        shell: pwsh
        working-directory: chocolatey/defguard
        run: |
          $old = Get-ChildItem -Filter "defguard.*.nupkg" | Where-Object { $_.Name -ne "defguard.$env:VERSION.nupkg" }
          if ($old) { $old | Remove-Item -Force }

      - name: Pack Chocolatey package
        shell: pwsh
        working-directory: chocolatey/defguard
        run: choco pack

      - name: Dry run complete
        shell: pwsh
        run: Write-Output "Dry run finished successfully. No push executed."
