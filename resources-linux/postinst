#!/bin/sh
set -e

GROUP_NAME="defguard"
SERVICE_NAME="defguard-service"

# Get the name of user who is installing the client
get_installing_user() {
    # Method 1: Check standard environment variables when installing with CLI
    if [ -n "$SUDO_USER" ] && [ "$SUDO_USER" != "root" ]; then
        INSTALLING_USER="$SUDO_USER"
    elif [ -n "$USER" ] && [ "$USER" != "root" ]; then
        INSTALLING_USER="$USER"
    fi
    if [ -n "$INSTALLING_USER" ]; then
        echo "$INSTALLING_USER"
        return 0
    fi

    # Method 2: Check loginctl for latest session
    username=$(loginctl list-users --no-legend | awk '$1 >= 1000 {print $2; exit}')
    if [ -n "$username" ]; then
        echo "$username"
        return 0
    fi
    
    return 1
}

case "$1" in
    1|configure)
        # Create the group if it doesn't exist
        if ! getent group "$GROUP_NAME" >/dev/null; then
            groupadd --system "$GROUP_NAME"
            echo "Created group $GROUP_NAME"
        else
            echo "Group $GROUP_NAME exists already."
        fi

        # Determine target user
        TARGET_USER=$(get_installing_user)
        echo "Installation triggered by user $TARGET_USER"

        # Add user to group if we found a valid target
        if [ -n "$TARGET_USER" ]; then
            if getent passwd "$TARGET_USER" >/dev/null; then
                # Try to add user to group and check if it succeeded
                if usermod -a -G "$GROUP_NAME" "$TARGET_USER"; then
                    echo "Added user $TARGET_USER to group $GROUP_NAME"

                    # Only show reboot message if user was actually added
                    echo "================================================"
                    echo "  IMPORTANT: Reboot or Re-login Required"
                    echo "================================================"
                    echo "The user has been added to the defguard group."
                    echo "Please reboot or log out and back in for the"
                    echo "group membership changes to take effect."
                    echo "================================================"
                else
                    echo "Warning: Failed to add user $TARGET_USER to group $GROUP_NAME"
                    exit 1
                fi
            fi
        else
            echo "User $TARGET_USER is not a valid target. Not adding the user to group $GROUP_NAME"
        fi

        # Handle systemd service
        if [ -d /run/systemd/system ]; then
            echo "Updating systemd service $SERVICE_NAME"

            # Reload systemd to recognize new service file
            systemctl daemon-reload

            # Enable service to start on boot
            systemctl enable "$SERVICE_NAME"

            # Start the service now
            systemctl start "$SERVICE_NAME"
        fi
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        # On failed operations, ensure service is running if it should be
        if [ -d /run/systemd/system ]; then
            echo "Restarting systemd service $SERVICE_NAME"
            systemctl daemon-reload
            if systemctl is-enabled "$SERVICE_NAME" >/dev/null 2>&1; then
                systemctl start "$SERVICE_NAME" || true
            fi
        fi
        ;;
esac

#DEBHELPER#
